<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeu 4e — Molécules : formule ↔ modèle + compter les atomes</title>
  <style>
    :root{
      --bg:#ffffff;
      --ink:#0b1220;
      --blue:#1f55ff;
      --good:#2ecc71;
      --bad:#e74c3c;
      --panel2:#d6ecff;
      --shadow: 0 8px 24px rgba(0,0,0,.15);
      --fontTitle: "Comic Sans MS","Comic Sans","Trebuchet MS",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      --font: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--font)}
    .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;position:relative;overflow:hidden}

    .bgmols{position:absolute;inset:0;opacity:.18;pointer-events:none}
    .bgmols .mol{position:absolute;transform: rotate(var(--rot));filter: drop-shadow(0 8px 8px rgba(0,0,0,.08));}

    .atom{
      width:40px;height:40px;border-radius:50%;
      border:2px solid rgba(0,0,0,.25);
      box-shadow: 0 10px 16px rgba(0,0,0,.12);
      flex: 0 0 auto;
    }

    .card{width:min(980px,100%);background:transparent;border-radius:18px;padding:10px 10px 14px;position:relative}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 6px 14px;flex-wrap:wrap}
    .title{font-family:var(--fontTitle);font-size:clamp(18px,2.4vw,26px);color:var(--blue);font-weight:800;letter-spacing:.2px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    select, button{
      font-family:var(--font);font-size:14px;border-radius:12px;border:1px solid rgba(0,0,0,.18);
      padding:10px 12px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.06)
    }
    button{cursor:pointer}
    button:hover{transform:translateY(-1px)}
    .stats{display:flex;gap:10px;flex-wrap:wrap;padding:0 6px 12px;color:rgba(0,0,0,.75);font-size:14px}
    .pill{background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.10);border-radius:999px;padding:8px 10px}
    .pill b{color:rgba(0,0,0,.9)}

    .scene{
      background:rgba(255,255,255,.78);
      border:1px solid rgba(0,0,0,.10);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:18px 18px 14px;
      position:relative;
    }
    .question{
      font-family:var(--fontTitle);color:var(--blue);
      font-size:clamp(18px,3.0vw,32px);font-weight:900;text-align:center;line-height:1.2;
      margin:6px 0 14px;text-shadow:0 2px 0 rgba(255,255,255,.9)
    }
    .center{display:flex;justify-content:center;align-items:center;min-height:190px;margin:6px 0 6px;gap:18px;flex-wrap:wrap}

    .methane{
      position:relative;
      --s:56px; --d:56px;
      width: calc(var(--s) * 3);
      height: calc(var(--s) * 3);
      flex: 0 0 auto;
    }
    .methane.small{ --s:44px; --d:44px; width: calc(var(--s) * 3); height: calc(var(--s) * 3); }
    .methane.mini{ --s:34px; --d:34px; width: calc(var(--s) * 3); height: calc(var(--s) * 3); }
    .methane .a{position:absolute; width:var(--s); height:var(--s); border-radius:50%;}
    .methane .centerC{left:50%;top:50%;transform:translate(-50%,-50%)}
    .methane .topH{left:50%;top:calc(50% - var(--d));transform:translate(-50%,-50%)}
    .methane .bottomH{left:50%;top:calc(50% + var(--d));transform:translate(-50%,-50%)}
    .methane .leftH{left:calc(50% - var(--d));top:50%;transform:translate(-50%,-50%)}
    .methane .rightH{left:calc(50% + var(--d));top:50%;transform:translate(-50%,-50%)}

    .group{
      display:flex;align-items:center;gap:18px;flex-wrap:wrap;justify-content:center;
      padding:6px 0;max-width: 100%;
    }
    .molItem{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(0,0,0,.03);
      max-width: 100%;
    }
    .plusSign{
      font-family:var(--fontTitle);
      font-size:34px;font-weight:900;color:rgba(0,0,0,.45);
      margin:0 6px;
    }
    .molStack{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:center;max-width:100%}
    .molClone{display:flex;align-items:center;justify-content:center}

    .molModel{display:flex;align-items:center;gap:0}
    .molModel.big .atom{width:56px;height:56px}
    .molModel.small .atom{width:44px;height:44px}
    .molModel.mini .atom{width:34px;height:34px}

    .rotatable{
      display:inline-flex;
      transform-origin: 50% 50%;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.10));
    }

    .eqBox{display:flex;justify-content:center;margin-top:8px}
    .equation{
      background:var(--panel2);border-radius:10px;padding:10px 14px;
      font-family:"Georgia","Times New Roman",serif;
      font-size:clamp(22px,3.2vw,46px);font-weight:700;
      display:flex;align-items:baseline;gap:14px;
      box-shadow:0 8px 18px rgba(0,0,0,.12);
      border:1px solid rgba(0,0,0,.10);
      flex-wrap:wrap;justify-content:center;
    }
    .equation .term{display:flex;align-items:baseline;gap:10px;white-space:nowrap}
    .equation .coef{font-size:1.05em}
    .equation .formula{font-weight:900;letter-spacing:.5px}
    .equation small{font-size:.6em;vertical-align:baseline;position:relative;top:.25em}
    .plus{font-weight:900;padding:0 2px}

    .answers{margin-top:14px;display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media (max-width:700px){.answers{grid-template-columns:1fr}}
    .ansBtn{
      border-radius:14px;border:1px solid rgba(0,0,0,.14);
      background:#fff;box-shadow:0 8px 16px rgba(0,0,0,.08);
      padding:12px 12px;font-size:clamp(18px,2.2vw,26px);
      font-weight:900;cursor:pointer;text-align:center;
    }
    .ansBtn.correct{outline:4px solid rgba(46,204,113,.35);border-color:rgba(46,204,113,.6)}
    .ansBtn.wrong{outline:4px solid rgba(231,76,60,.25);border-color:rgba(231,76,60,.55)}

    .inputRow{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:10px}
    input[type="number"]{
      font-size:20px;font-weight:800;padding:10px 12px;width:140px;
      border-radius:14px;border:2px solid rgba(0,0,0,.18);
      box-shadow:0 6px 14px rgba(0,0,0,.08);
      outline:none;text-align:center;
    }
    input[type="number"]:focus{border-color:rgba(31,85,255,.55)}
    .checkBtn{font-weight:900;background:#fff}

    .feedback{margin-top:10px;text-align:center;font-size:16px;min-height:22px;color:rgba(0,0,0,.75)}
    .feedback.good{color:#1f7a3b;font-weight:800}
    .feedback.bad{color:#9c2f24;font-weight:800}

    .autoCorrect{
      display:none;margin-top:12px;border-radius:16px;
      border:3px solid rgba(231,76,60,.55);
      background: rgba(231,76,60,.10);
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      padding:12px 14px;
    }
    .autoCorrect.show{display:block}
    .autoCorrect .acTitle{
      font-family:var(--fontTitle);
      font-size:22px;font-weight:900;color:#9c2f24;text-align:center;margin-bottom:6px;
    }
    .autoCorrect .acBody{
      font-size:15px;line-height:1.35;color:rgba(0,0,0,.82);text-align:center;
    }
    .autoCorrect .acBody b{color:rgba(0,0,0,.92)}
    .autoCorrect .acBody small{font-size:.8em}

    .nextBubble{
      position:absolute;right:16px;bottom:14px;width:48px;height:48px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #7dffb0, var(--good));
      border:2px solid rgba(0,0,0,.18);
      box-shadow:0 10px 18px rgba(0,0,0,.18);
      display:grid;place-items:center;cursor:pointer;user-select:none;
    }
    .nextBubble:active{transform:scale(.98)}
    .triangle{
      width:0;height:0;border-top:10px solid transparent;border-bottom:10px solid transparent;
      border-left:16px solid rgba(0,0,0,.55);margin-left:3px;
    }
    .tiny{color:rgba(0,0,0,.62);font-size:12px;text-align:center;margin-top:10px}
  </style>
</head>

<body>
<div class="app">
  <div class="bgmols" id="bgmols"></div>

  <div class="card">
    <div class="topbar">
      <div class="title">Jeu — Molécules (4e)</div>
      <div class="controls">
        <label style="display:flex;align-items:center;gap:8px">
          Niveau :
          <select id="level">
            <option value="beginner">Débutant</option>
            <option value="medium" selected>Moyen</option>
            <option value="expert">Expert</option>
          </select>
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          Mode :
          <select id="mode">
            <option value="mix" selected>Mixte</option>
            <option value="formula">Formule de la molécule</option>
            <option value="count">Compter des atomes</option>
          </select>
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          Questions :
          <select id="qmax">
            <option>10</option>
            <option>15</option>
            <option>20</option>
          </select>
        </label>

        <button id="start">Nouvelle partie</button>
      </div>
    </div>

    <div class="stats">
      <div class="pill">Question : <b id="qnum">0</b>/<b id="qmaxDisp">10</b></div>
      <div class="pill">Score : <b id="score">0</b></div>
      <div class="pill">Série : <b id="streak">0</b></div>
    </div>

    <div class="scene">
      <div class="question" id="question">Clique sur “Nouvelle partie”.</div>

      <div class="center" id="center"></div>

      <div class="eqBox" id="eqBox" style="display:none">
        <div class="equation" id="equation"></div>
      </div>

      <div class="answers" id="answers" style="display:none"></div>

      <div class="inputRow" id="inputRow" style="display:none">
        <input type="number" id="numInput" min="0" step="1" placeholder="?" />
        <button class="checkBtn" id="check">Vérifier</button>
      </div>

      <div class="feedback" id="feedback"></div>

      <div class="autoCorrect" id="autoCorrect">
        <div class="acTitle">CORRECTION (à lire !)</div>
        <div class="acBody" id="autoCorrectBody"></div>
      </div>

      <div class="tiny">Raccourcis : <b>Entrée</b> = vérifier (en mode “compter”), <b>→</b> = question suivante.</div>

      <div class="nextBubble" id="nextBubble" title="Question suivante">
        <div class="triangle"></div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const ATOMS = {
    H: { name:"Hydrogène", color:"#ffffff", border:"rgba(0,0,0,.28)" },
    O: { name:"Oxygène",   color:"#ff1e1e", border:"rgba(0,0,0,.22)" },
    C: { name:"Carbone",   color:"#111111", border:"rgba(0,0,0,.22)" },
    N: { name:"Azote",     color:"#2f66ff", border:"rgba(0,0,0,.22)" },
  };

  const MOLECULES = [
    { key:"H2O", name:"Eau",               html:"H<small>2</small>O", counts:{H:2,O:1} },
    { key:"CO2", name:"Dioxyde de carbone",html:"CO<small>2</small>", counts:{C:1,O:2} },
    { key:"O2",  name:"Dioxygène",         html:"O<small>2</small>",  counts:{O:2} },
    { key:"H2",  name:"Dihydrogène",       html:"H<small>2</small>",  counts:{H:2} },
    { key:"N2",  name:"Diazote",           html:"N<small>2</small>",  counts:{N:2} },
    { key:"CH4", name:"Méthane",           html:"CH<small>4</small>", counts:{C:1,H:4} },
    { key:"N2O", name:"Protoxyde d’azote", html:"N<small>2</small>O", counts:{N:2,O:1} },
  ];

  // ===== Difficulty profiles =====
  const LEVELS = {
    beginner: {
      // very accessible
      formula: { multiProb: 0.25, multiTerms: [2,2], coefMin: 1, coefMax: 3 },
      count:   { terms: [2,2], coefMin: 1, coefMax: 6 },
      mix:     { formulaProb: 0.65 } // more formula than counting
    },
    medium: {
      formula: { multiProb: 0.55, multiTerms: [2,3], coefMin: 1, coefMax: 5 },
      count:   { terms: [2,3], coefMin: 1, coefMax: 20 },
      mix:     { formulaProb: 0.55 }
    },
    expert: {
      formula: { multiProb: 0.80, multiTerms: [3,4], coefMin: 1, coefMax: 8 },
      count:   { terms: [3,4], coefMin: 5, coefMax: 50 },
      mix:     { formulaProb: 0.45 } // more counting (harder)
    }
  };

  const $ = (id) => document.getElementById(id);
  const elMode = $("mode");
  const elLevel = $("level");
  const elQmax = $("qmax");
  const elStart = $("start");
  const elNextBubble = $("nextBubble");

  const elQnum = $("qnum");
  const elQmaxDisp = $("qmaxDisp");
  const elScore = $("score");
  const elStreak = $("streak");

  const elQuestion = $("question");
  const elCenter = $("center");
  const elEqBox = $("eqBox");
  const elEquation = $("equation");
  const elAnswers = $("answers");
  const elInputRow = $("inputRow");
  const elNumInput = $("numInput");
  const elCheck = $("check");
  const elFeedback = $("feedback");

  const elCorrectionBox = $("autoCorrect");
  const elCorrectionBody = $("autoCorrectBody");

  let qMax = 10, qNum = 0, score = 0, streak = 0;
  let running = false, locked = false;
  let current = null;

  const shuffle = (arr) => {
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  };
  const pickOne = (arr) => arr[Math.floor(Math.random()*arr.length)];
  const byKey = (k) => MOLECULES.find(m => m.key === k);
  const randInt = (min, max) => Math.floor(Math.random()*(max-min+1))+min;
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));

  function levelCfg(){
    return LEVELS[elLevel.value] || LEVELS.medium;
  }

  function setStats(){
    elQnum.textContent = String(qNum);
    elQmaxDisp.textContent = String(qMax);
    elScore.textContent = String(score);
    elStreak.textContent = String(streak);
  }
  function hideCorrection(){
    elCorrectionBox.classList.remove("show");
    elCorrectionBody.innerHTML = "";
  }
  function resetUI(){
    elCenter.innerHTML = "";
    elEquation.innerHTML = "";
    elAnswers.innerHTML = "";
    elFeedback.textContent = "";
    elFeedback.className = "feedback";
    elEqBox.style.display = "none";
    elAnswers.style.display = "none";
    elInputRow.style.display = "none";
    elNumInput.value = "";
    hideCorrection();
  }
  function setFeedback(text, ok){
    elFeedback.textContent = text;
    elFeedback.className = "feedback " + (ok ? "good" : "bad");
  }
  function showCorrection(html){
    elCorrectionBody.innerHTML = html;
    elCorrectionBox.classList.add("show");
  }
  function finish(){
    running = false;
    locked = true;
    resetUI();
    const pct = Math.round((score/qMax)*100);
    elQuestion.textContent = `Terminé ! Score : ${score}/${qMax} (${pct}%)`;
    setFeedback("Tu peux relancer une partie ou changer de mode/niveau.", true);
  }

  function makeAtom(sym){
    const a = document.createElement("div");
    a.className = "atom";
    a.style.background = ATOMS[sym].color;
    a.style.borderColor = ATOMS[sym].border;
    return a;
  }

  // Rotation helpers
  function randBetween(min, max){ return min + Math.random() * (max - min); }
  function rotationRangeForSize(size){
    if (size === "big") return 10;
    if (size === "small") return 18;
    return 22;
  }
  function wrapRotated(node, size){
    const r = rotationRangeForSize(size);
    const angle = randBetween(-r, r);
    const wrap = document.createElement("div");
    wrap.className = "rotatable";
    wrap.style.transform = `rotate(${angle}deg)`;
    wrap.appendChild(node);
    return wrap;
  }

  function renderMethane(size){
    const wrap = document.createElement("div");
    wrap.className = "methane " + (size === "mini" ? "mini" : size === "small" ? "small" : "");
    const C = makeAtom("C"); C.classList.add("a","centerC"); wrap.appendChild(C);
    const Ht = makeAtom("H"); Ht.classList.add("a","topH"); wrap.appendChild(Ht);
    const Hb = makeAtom("H"); Hb.classList.add("a","bottomH"); wrap.appendChild(Hb);
    const Hl = makeAtom("H"); Hl.classList.add("a","leftH"); wrap.appendChild(Hl);
    const Hr = makeAtom("H"); Hr.classList.add("a","rightH"); wrap.appendChild(Hr);
    wrap.querySelectorAll(".atom").forEach(a => { a.style.width="var(--s)"; a.style.height="var(--s)"; });
    return wrap;
  }

  function renderMolModel(key, size){
    const m = byKey(key);

    if (m.key === "CH4"){
      const div = document.createElement("div");
      div.className = "molModel " + size;
      div.appendChild(renderMethane(size));
      return wrapRotated(div, size);
    }

    const atomsMap = {
      H2O: ["H","O","H"],
      CO2: ["O","C","O"],
      O2:  ["O","O"],
      H2:  ["H","H"],
      N2:  ["N","N"],
      N2O: ["N","N","O"]
    };
    const atoms = atomsMap[m.key];

    const row = document.createElement("div");
    row.className = "molModel " + size;
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "0px";
    atoms.forEach(sym => row.appendChild(makeAtom(sym)));

    return wrapRotated(row, size);
  }

  function chooseRepeatSize(totalMolecules){
    if (totalMolecules >= 10) return "mini";
    if (totalMolecules >= 6) return "small";
    return "small";
  }

  // Grammar helpers
  function deOrD(sym){
    const map = { H: "d’hydrogène", O: "d’oxygène", N: "d’azote", C: "de carbone" };
    return map[sym] || ("de " + sym);
  }
  function atomName(sym){
    if (sym === "H") return "hydrogène";
    if (sym === "O") return "oxygène";
    if (sym === "C") return "carbone";
    if (sym === "N") return "azote";
    return sym;
  }

  // Hide "1" before formulas when coef === 1
  function formatExpressionHTML(exprTerms){
    return exprTerms.map((t, i) => {
      const coef = (t.coef === 1) ? "" : `<span class="coef">${t.coef}</span>`;
      const space = (t.coef === 1) ? "" : " ";
      const f = `<span class="formula">${byKey(t.key).html}</span>`;
      const plus = (i < exprTerms.length-1) ? `<span class="plus"> + </span>` : "";
      return `${coef}${space}${f}${plus}`;
    }).join("");
  }

  function renderMultiModels(exprTerms){
    const wrap = document.createElement("div");
    wrap.className = "group";

    const totalMolecules = exprTerms.reduce((s,t)=>s+t.coef,0);
    const size = chooseRepeatSize(totalMolecules);

    exprTerms.forEach((t, i) => {
      const item = document.createElement("div");
      item.className = "molItem";

      const stack = document.createElement("div");
      stack.className = "molStack";

      for (let n = 0; n < t.coef; n++){
        const clone = document.createElement("div");
        clone.className = "molClone";
        clone.appendChild(renderMolModel(t.key, size));
        stack.appendChild(clone);
      }

      item.appendChild(stack);
      wrap.appendChild(item);

      if (i < exprTerms.length - 1){
        const plus = document.createElement("div");
        plus.className = "plusSign";
        plus.textContent = "+";
        wrap.appendChild(plus);
      }
    });

    return wrap;
  }

  // ===== Question type selection (uses difficulty) =====
  function pickQuestionType(){
    const mode = elMode.value;
    const cfg = levelCfg();
    if (mode === "formula") return "formula";
    if (mode === "count") return "count";
    return Math.random() < cfg.mix.formulaProb ? "formula" : "count";
  }

  // ===== Formula questions =====
  function buildFormulaSingle(){
    const keys = MOLECULES.map(m => m.key);
    const correctKey = pickOne(keys);

    const choices = shuffle([correctKey, ...shuffle(keys.filter(k => k !== correctKey)).slice(0,3)]);
    current = { type:"formulaSingle", correctKey, choices };

    elQuestion.textContent = "Quelle est la formule de cette molécule ?";
    elCenter.appendChild(renderMolModel(correctKey, "big"));

    elAnswers.style.display = "grid";
    elAnswers.innerHTML = "";
    choices.forEach((k) => {
      const btn = document.createElement("button");
      btn.className = "ansBtn";
      btn.innerHTML = byKey(k).html;
      btn.addEventListener("click", () => answerFormulaSingle(k, btn));
      elAnswers.appendChild(btn);
    });

    setFeedback("Clique sur la bonne formule.", true);
  }

  function answerFormulaSingle(choiceKey, btn){
    if (!running || locked) return;
    locked = true;

    const correctKey = current.correctKey;
    [...elAnswers.querySelectorAll(".ansBtn")].forEach(b => {
      if (b.innerHTML === byKey(correctKey).html) b.classList.add("correct");
    });

    if (choiceKey === correctKey){
      score += 1; streak += 1;
      btn.classList.add("correct");
      setFeedback("Bravo ! Bonne réponse ✅", true);
    } else {
      streak = 0;
      btn.classList.add("wrong");
      setFeedback("Non ❌ Regarde la correction juste en dessous.", false);

      const mol = byKey(correctKey);
      showCorrection(
        `✅ <b>Réponse :</b> ${mol.html}<br>
         <small>Astuce : compte les boules (couleurs) : H (blanc), O (rouge), C (noir), N (bleu).</small>`
      );
    }
    setStats();
  }

  function buildFormulaMulti(){
    const cfg = levelCfg().formula;

    const minT = cfg.multiTerms[0], maxT = cfg.multiTerms[1];
    const n = randInt(minT, maxT);

    const selected = shuffle(MOLECULES).slice(0, clamp(n, 2, MOLECULES.length));

    const terms = selected.map(m => ({
      coef: randInt(cfg.coefMin, cfg.coefMax),
      key: m.key
    }));

    const correctHTML = formatExpressionHTML(terms);

    const distractors = [];
    const used = new Set([correctHTML]);

    function pushIfNew(expr){
      const html = formatExpressionHTML(expr);
      if (!used.has(html)){
        used.add(html);
        distractors.push({ html, expr });
      }
    }

    // distractor 1: tweak one coefficient
    {
      const expr = terms.map(t => ({...t}));
      const i = randInt(0, expr.length-1);
      expr[i].coef = clamp(expr[i].coef + (Math.random()<0.5 ? 1 : -1), 1, cfg.coefMax);
      pushIfNew(expr);
    }
    // distractor 2: replace one molecule
    {
      const expr = terms.map(t => ({...t}));
      const i = randInt(0, expr.length-1);
      const other = pickOne(MOLECULES.filter(m => !expr.some(t => t.key === m.key)));
      if (other) expr[i].key = other.key;
      pushIfNew(expr);
    }
    // distractor 3: randomize one coefficient
    {
      const expr = terms.map(t => ({...t}));
      const i = randInt(0, expr.length-1);
      expr[i].coef = randInt(cfg.coefMin, cfg.coefMax);
      pushIfNew(expr);
    }

    while (distractors.length < 3){
      const expr = terms.map(t => ({...t}));
      const i = randInt(0, expr.length-1);
      expr[i].coef = randInt(cfg.coefMin, cfg.coefMax);
      pushIfNew(expr);
      if (used.size > 60) break;
    }

    const options = shuffle([{ html: correctHTML, expr: terms }, ...distractors.slice(0,3)]);
    current = { type:"formulaMulti", correctHTML, terms, options };

    elQuestion.textContent = "Quelle expression correspond à ce que tu vois ?";
    elCenter.appendChild(renderMultiModels(terms));

    elAnswers.style.display = "grid";
    elAnswers.innerHTML = "";
    options.forEach((opt) => {
      const btn = document.createElement("button");
      btn.className = "ansBtn";
      btn.innerHTML = opt.html;
      btn.addEventListener("click", () => answerFormulaMulti(opt, btn));
      elAnswers.appendChild(btn);
    });

    setFeedback("Choisis la bonne écriture (coefficients + formules).", true);
  }

  function buildFormulaQuestion(){
    const cfg = levelCfg().formula;

    // Beginner: mostly single molecules
    // Medium: mixed
    // Expert: mostly multi
    const isMulti = Math.random() < cfg.multiProb;
    if (isMulti) buildFormulaMulti();
    else buildFormulaSingle();
  }

  function answerFormulaMulti(opt, btn){
    if (!running || locked) return;
    locked = true;

    [...elAnswers.querySelectorAll(".ansBtn")].forEach(b => {
      if (b.innerHTML === current.correctHTML) b.classList.add("correct");
    });

    if (opt.html === current.correctHTML){
      score += 1; streak += 1;
      btn.classList.add("correct");
      setFeedback("Bravo ! Bonne réponse ✅", true);
    } else {
      streak = 0;
      btn.classList.add("wrong");
      setFeedback("Non ❌ Regarde la correction juste en dessous.", false);

      const lines = current.terms.map(t => {
        const name = byKey(t.key).name;
        return `• <b>${t.coef}</b> molécule(s) de <b>${name}</b> → ${t.coef === 1 ? "" : t.coef + " "}${byKey(t.key).html}`;
      }).join("<br>");

      showCorrection(
        `✅ <b>Réponse :</b> ${current.correctHTML}<br><br>
         <b>Comment se corriger :</b><br>
         ${lines}<br><br>
         <small>Astuce : le nombre devant la formule = “combien de molécules”. S’il vaut 1, on ne l’écrit pas.</small>`
      );
    }
    setStats();
  }

  // ===== Counting questions =====
  // Hide "1" coefficient in the blue equation panel
  function formatTerm(coef, mol){
    const term = document.createElement("span");
    term.className = "term";

    if (coef !== 1){
      const c = document.createElement("span");
      c.className = "coef";
      c.textContent = String(coef);
      term.appendChild(c);
    }

    const f = document.createElement("span");
    f.className = "formula";
    f.innerHTML = mol.html;
    term.appendChild(f);

    return term;
  }

  function countAtomsInExpression(terms, element){
    let total = 0;
    for (const t of terms){
      const m = byKey(t.moleculeKey);
      const perMol = (m.counts[element] || 0);
      total += t.coef * perMol;
    }
    return total;
  }

  function buildCountQuestion(){
    const cfg = levelCfg().count;

    const nTerms = randInt(cfg.terms[0], cfg.terms[1]);
    const mols = shuffle(MOLECULES).slice(0, clamp(nTerms, 2, MOLECULES.length));

    const terms = mols.map(m => ({
      coef: randInt(cfg.coefMin, cfg.coefMax),
      moleculeKey: m.key
    }));

    const presentElements = new Set();
    for (const t of terms){
      const cts = byKey(t.moleculeKey).counts;
      Object.keys(cts).forEach(e => presentElements.add(e));
    }

    // Expert: sometimes choose an element that appears in only 1 molecule term (harder “piège”)
    let element;
    if (elLevel.value === "expert" && Math.random() < 0.35){
      const elems = [...presentElements];
      const countsByElem = new Map();
      elems.forEach(e => countsByElem.set(e, 0));
      for (const t of terms){
        const cts = byKey(t.moleculeKey).counts;
        for (const e of elems){
          if ((cts[e] || 0) > 0) countsByElem.set(e, countsByElem.get(e)+1);
        }
      }
      const rare = elems.filter(e => countsByElem.get(e) === 1);
      element = rare.length ? pickOne(rare) : pickOne(elems);
    } else {
      element = pickOne([...presentElements]);
    }

    const correct = countAtomsInExpression(terms, element);
    current = { type:"count", terms, element, correct };

    elQuestion.textContent = `Combien y a-t-il d'atomes ${deOrD(element)} ?`;

    elEqBox.style.display = "flex";
    elEquation.innerHTML = "";

    terms.forEach((t, i) => {
      elEquation.appendChild(formatTerm(t.coef, byKey(t.moleculeKey)));
      if (i < terms.length - 1){
        const plus = document.createElement("span");
        plus.className = "plus";
        plus.textContent = "+";
        elEquation.appendChild(plus);
      }
    });

    elInputRow.style.display = "flex";
    elNumInput.value = "";
    elNumInput.focus();

    setFeedback("Écris le nombre total d’atomes, puis clique sur “Vérifier”.", true);
  }

  function checkCountAnswer(){
    if (!running || locked) return;
    const val = elNumInput.value.trim();
    if (val === "") return;

    const n = Number(val);
    if (!Number.isFinite(n) || n < 0){
      setFeedback("Entre un nombre valide.", false);
      return;
    }

    locked = true;
    if (n === current.correct){
      score += 1; streak += 1;
      setFeedback(`Bravo ✅ Il y a bien ${current.correct} atomes ${deOrD(current.element)}.`, true);
    } else {
      streak = 0;
      setFeedback("Non ❌ Regarde la correction juste en dessous.", false);

      const steps = current.terms.map(t => {
        const mol = byKey(t.moleculeKey);
        const perMol = mol.counts[current.element] || 0;
        return `• ${t.coef} × (${perMol} atome(s) ${deOrD(current.element)} dans ${mol.html}) = <b>${t.coef*perMol}</b>`;
      }).join("<br>");

      showCorrection(
        `✅ <b>Réponse :</b> ${current.correct}<br><br>
         <b>Correction (calcul) :</b><br>
         ${steps}<br>
         <b>Total</b> = ${current.correct}`
      );
    }
    setStats();
  }

  // ===== Flow =====
  function nextQuestion(){
    if (!running) return;
    if (qNum >= qMax){ finish(); return; }

    qNum += 1;
    locked = false;
    resetUI();

    const type = pickQuestionType();
    if (type === "formula") buildFormulaQuestion();
    else buildCountQuestion();

    setStats();
  }

  function startGame(){
    qMax = Number(elQmax.value);
    qNum = 0; score = 0; streak = 0;
    running = true;
    locked = false;
    setStats();
    nextQuestion();
  }

  // Decorative background
  function buildBackground(){
    const bg = document.getElementById("bgmols");
    const samples = ["H2O","CO2","O2","H2","N2","CH4","N2O"];
    const coords = [
      [6,10, -12],[70,8, 8],[18,42, 15],[82,38,-10],[10,78, 12],[55,72,-8],[88,76, 10],
      [40,18, 6],[32,88,-6],[62,52, 12]
    ];
    coords.forEach(([x,y,rot], i) => {
      const k = samples[i % samples.length];
      const wrap = document.createElement("div");
      wrap.className = "mol";
      wrap.style.left = x + "%";
      wrap.style.top = y + "%";
      wrap.style.setProperty("--rot", rot + "deg");

      const model = renderMolModel(k, "mini");
      model.style.transform = `scale(.9) ${model.style.transform || ""}`.trim();

      wrap.appendChild(model);
      bg.appendChild(wrap);
    });
  }

  elStart.addEventListener("click", startGame);
  elNextBubble.addEventListener("click", nextQuestion);
  elCheck.addEventListener("click", checkCountAnswer);

  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowRight") nextQuestion();
    if (e.key === "Enter"){
      if (current?.type === "count" && !locked) checkCountAnswer();
    }
  });

  buildBackground();
  setStats();
})();
</script>
</body>
</html>
